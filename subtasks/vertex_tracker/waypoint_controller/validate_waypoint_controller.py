import gym
import torch
import numpy as np

import evaluate_glider

from subtasks.vertex_tracker.waypoint_controller.waypoint_controller import Waypoint_Controller
from subtasks.vertex_tracker import params_vertex_tracker

device = torch.device("cuda:0")

class Controller_Wrapper:
    def __init__(self, environment):
        self.waypoint_controller = Waypoint_Controller()
        self.env = environment
        self._params_agent = params_vertex_tracker.params_agent()

    def select_action(self, obserervation, memory=None, validation_mask=False):
        phi_cmd, alpha_cmd = self.waypoint_controller.get_control(self.env.state, self.env.activeVertex)
        action = np.array([self.wrap_to_interval(phi_cmd, self._params_agent.ACTION_SPACE[0, :] * np.pi/180),
                           self.wrap_to_interval(alpha_cmd, self._params_agent.ACTION_SPACE[1, :] * np.pi/180)])
        return action

    def wrap_to_interval(self, value, source_interval, target_interval=np.array([-1, 1])):
        wrapped_value = np.interp(value, (source_interval.min(), source_interval.max()),
                                  (target_interval.min(), target_interval.max()))
        return wrapped_value

def main():
    env = gym.make('glider3D-v0', agent='vertex_tracker')
    controller = Controller_Wrapper(env)
    evaluate_glider.main(env, controller, 0, params_vertex_tracker.params_agent(), validation_mask=False)
    env.close()

if __name__ == '__main__':
    main()